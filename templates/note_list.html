{% extends "base.html" %}

{% block title %}‚óù(·µî·óú·µî)‚óú–ù–∞—à–∏ —Å–æ–∫—Ä–æ–≤–∏—â–∞‚óù(·µî·óú·µî)‚óú{% endblock %}

{% block content %}
    <h1 class="text-center mb-4 title">–ù–∞—à–µ —Å —Ç–æ–±–æ–π –±–æ–≥–∞—Ç—Å—Ç–≤–æ...</h1>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="text-center mb-4">
        <button class="btn btn-primary filter-btn" data-filter="all">–í—Å–µ</button>
        <button class="btn btn-success filter-btn" data-filter="read">–ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</button>
        <button class="btn btn-warning filter-btn" data-filter="unread">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ</button>
        <button class="btn btn-danger filter-btn" data-filter="secret">–°–µ–∫—Ä–µ—Ç–Ω—ã–µ</button>
        <button class="btn btn-info filter-btn" data-filter="regular">–û–±—ã—á–Ω—ã–µ</button>
    </div>

    {% if notes %}
        <div class="row">
            {% for note in notes %}
                <div class="col-md-6 col-lg-4 mb-4 note-card"
                     data-read="{% if note.is_read %}read{% else %}unread{% endif %}"
                     data-secret="{% if note.is_secret %}secret{% else %}regular{% endif %}">
                    <a href="{% url 'note_detail' note.id %}" class="card shadow {% if note.is_secret %}border-danger{% else %}border-primary{% endif %} text-decoration-none">
                        <div class="card-body">
                            <h5 class="card-title">
                                {% if note.is_secret %} üîí –°–µ–∫—Ä–µ—Ç–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è {% else %} üìù –û–±—ã—á–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è {% endif %}
                            </h5>
                            <p class="card-text {% if note.is_secret %}secret-note{% endif %}">
                                {{ note.text|truncatechars:50 }}
                            </p>
                            <p class="text-muted">
                                <span id="status-{{ note.id }}">
                                    {% if note.is_read %} ‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω–∞ {% else %} ‚ùå –ù–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–∞ {% endif %}
                                </span>
                            </p>
                            <button class="btn {% if note.is_read %}btn-warning{% else %}btn-success{% endif %} toggle-read" 
                                    data-id="{{ note.id }}">
                                {% if note.is_read %} –°–¥–µ–ª–∞—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–π {% else %} –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–π {% endif %}
                            </button>
                        </div>
                    </a>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-center text-muted">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫.</p>
    {% endif %}

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º GSAP –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
            gsap.from(".title", { opacity: 0, y: -50, duration: 1.5, ease: "power3.out" });

            // –†–∞–∑–ª–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫
            let cards = document.querySelectorAll(".note-card");
            gsap.set(cards, {
                opacity: 0,
                scale: 0.5,
                x: () => gsap.utils.random(-200, 200),
                y: () => gsap.utils.random(-200, 200)
            });

            gsap.to(cards, {
                opacity: 1,
                scale: 1,
                x: 0,
                y: 0,
                duration: 1.5,
                ease: "power3.out",
                stagger: 0.1
            });

            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
            document.querySelectorAll(".filter-btn").forEach(button => {
                button.addEventListener("click", function () {
                    let filter = this.getAttribute("data-filter");
                    document.querySelectorAll(".note-card").forEach(card => {
                        let isRead = card.getAttribute("data-read");
                        let isSecret = card.getAttribute("data-secret");

                        if (filter === "all" ||
                            (filter === "read" && isRead === "read") ||
                            (filter === "unread" && isRead === "unread") ||
                            (filter === "secret" && isSecret === "secret") ||
                            (filter === "regular" && isSecret === "regular")) {
                            gsap.to(card, { opacity: 1, scale: 1, duration: 0.5, ease: "power2.out" });
                        } else {
                            gsap.to(card, { opacity: 0, scale: 0.8, duration: 0.5, ease: "power2.in" });
                        }
                    });
                });
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ/–ù–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ"
            document.querySelectorAll(".toggle-read").forEach(button => {
                button.addEventListener("click", function (event) {
                    event.preventDefault();
                    let noteId = this.getAttribute("data-id");
                    let button = this;
                    let statusSpan = document.getElementById(`status-${noteId}`);
                    let card = button.closest(".note-card");

                    fetch(`/toggle-read/${noteId}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": getCookie("csrftoken"),
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            statusSpan.innerHTML = data.is_read ? "‚úÖ –ü—Ä–æ—á–∏—Ç–∞–Ω–∞" : "‚ùå –ù–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–∞";
                            button.classList.toggle("btn-success", !data.is_read);
                            button.classList.toggle("btn-warning", data.is_read);
                            button.innerText = data.is_read ? "–°–¥–µ–ª–∞—Ç—å –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–π" : "–°–¥–µ–ª–∞—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–π";

                            // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                            card.setAttribute("data-read", data.is_read ? "read" : "unread");
                        }
                    });
                });
            });

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== "") {
                    let cookies = document.cookie.split(";");
                    for (let i = 0; i < cookies.length; i++) {
                        let cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + "=")) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>

    <!-- –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫ -->
    <style>
        .secret-note {
            filter: blur(3px);
            opacity: 0;
        }
    </style>
    <h1 class="text-center mb-4 title">...—ç—Ç–æ —Ç–æ, —á–µ—Ä–µ–∑ —á—Ç–æ –º—ã —Å —Ç–æ–±–æ–π –ø—Ä–æ—à–ª–∏(À∂ÀÉ ·µï ÀÇÀ∂)</h1>
{% endblock %}
